<!doctype html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta content="always" name="referrer">
    <script src="/.../echarts/echarts.min.js"></script>
</head>
<body>
<div class="J_conWarp g-lr-mg g-warning-box">
    <h4 class="g-title"> <a href="javascript:history.back()" style="font-size: 16px; color: black; " >< 返回</a></h4>
    <div class="J_containerWarp">
        <div  class="container-fluid g-t-mg2">
            <div class="row" >
                <div class="col-xs-12" >
                    <div id="import_file">
                        <form class="form-horizontal" role="form" id="excelExportForm">
                        </form>
                        <form class="form-horizontal" role="form" id="downloadErrorExcelForm">
                            <input type="hidden" name="fileName" id="fileName" value="" />
                        </form>
                        <form class="form-horizontal" role="form" id="form1">
                            <div class="form-group ">
                                <label class="col-xs-2 control-label"><em class="text-red">*</em>导入文件</label>
                                <div class="col-xs-10">
                                    <input type="file" id="file" name="file" class="form-control" style="width:400px" accept=".xls" />
                                </div>
                            </div>

                        </form>
                        <div  class="form-group ">
                            <label class="col-xs-2 control-label"></label>
                            <a class="gbn gbn-m" href="javascript:" onclick="E.excelExport();" >下载导入模板</a>
                            <a class="gbn gbn-m" href="javascript:" onclick="E.saveExcel();" >导入</a>
                            <a class="gbn gbn-m gbn-red" href="javascript:" onclick="history.back();" >返回</a>
                        </div>
                    </div>

                    <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
                    <div id="main" style="width:100%;height:550px;"></div>
                    <div  id="downloadErrorExcelA"class="col-xs-12" style="height:150px;width:100%;display:none">
                        <div class="col-xs-4"></div>
                        <div  class="form-group ">
                            <a class="gbn gbn-m gbn-red"   href="javascript:" onclick="E.downloadErrorExcel();" >下载错误文件</a>
                            <a id="quxiao" class="gbn gbn-m"   href="javascript:" onclick="E.quxiao();" >取消</a>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

</div>
</body>

<script type="text/javascript">
    window.onload = window.onresize = function() {
      $(".J_containerWarp").height($(window).height() - 60);
      $(".J_containerWarp").niceScroll({});
    }
    $.ajaxSettings.async=true;
    var uuid=null;
    var setInterval_id=null;
    var myChart = echarts.init(document.getElementById('main'));
    var option = {
        title : {
            text: '正在进行导入中...',
            subtext: '当前进度',
            x:'center'
        },
        tooltip : {
            trigger: 'item',
            formatter: "{a} <br/>{b} : {c} ({d}%)"
        },
        legend: {
            orient: 'vertical',
            left: 'right',
            data: ['导入成功','导入失败','未处理']
        },
        series : [
            {
                name: '导入进度',
                type: 'pie',
                // radius : '55%',
                radius: ['50%', '70%'],
                center: ['50%', '60%'],
                data:[
                    {value:0, name:'导入成功'},
                    {value:0, name:'导入失败'},
                    {value:100, name:'未处理'}
                ],
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                color: ['#2ECC71','#E67E22','#BDC3C7'],
            }
        ]
    };
    var E = {
        excelExport : function() {
            $("form[id=excelExportForm]").attr("action",
                    "${request.contextPath}/student_import/v1/excelExport");
            $("#excelExportForm").submit();
        },
        saveExcel : function() {
            var file = $("#file").val();
            if(!file){
                Message.error("导入的文件不能为空");
                return ;
            }
            //循环获取进度信息
            setInterval_id=setInterval(E.getAsynInfo,500);
            myChart.setOption(option);
            var index = layer.load(1);
            var formData = new FormData();
            //隐藏导入区域和错误文件下载区域,显示进度条区域
            $("#import_file").hide();
            $("#main").show();
            $("#downloadErrorExcelA").hide();
            formData.append('file', $('#file')[0].files[0]);
             $.ajax({
                    type : "POST",
                    url : "${request.contextPath}/student_import/v1/save_excel",
                    data : formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success : function(o) {
                        if(o.code==1){
                            //设置uuid
                            uuid=o.uuid;
                        } else {
                            Message.error(o.msg);
                        }
                }
            });
        },
        downloadErrorExcel : function() {
            $("form[id=downloadErrorExcelForm]").attr("action",
                    "${request.contextPath}/student_import/v1/downloadErrorExcel");
            $("#downloadErrorExcelForm").submit();
        },
        getAsynInfo:function(){
            //如果uuid存在,进行获取数据
            if(uuid!=null){
                $.post("${request.contextPath}/student_import/v1/get_plan",{"uuid":uuid},function(o){
                    console.log(o);
                    //如果获取到了数据
                    if(o.code==1&&o.data!=null){
                        // 使用指定的配数据显示图表。
                        option.title.subtext="当前进度   [共"+o.data.totality+"]条";
                        option.series[0].data[0].value=o.data.successSum;
                        option.series[0].data[1].value=o.data.errorSum;
                        option.series[0].data[2].value=o.data.totality-o.data.doneSum;
                        myChart.setOption(option);
                        //如果导入结束了
                        if(o.data.isEnd){
                            option.title.text="导入完成";
                            myChart.setOption(option);
                            clearInterval(setInterval_id);
                            //如果有错误数据,展示错误文件的下载
                            if(o.data.totality>0&&o.data.errorSum>0){
                                $("#fileName").val(o.data.errorFilePath);
                                $("#downloadErrorExcelA").show();
                            }
                            //如果导入中出现的异常
                            if(o.data.msg!=null){
                                $("#import_file").show();
                                $("#main").hide();
                                Message.error(o.data.msg);
                            }else{
                                Message.success("导入结束,"+o.data.successSum+"条数据导入成功,"+o.data.errorSum+"条数据导入失败");
                            }
                        }
                    }else{
                        Message.error(o.msg);
                    }
                });
            }
        },
        quxiao:function () {
            $("#import_file").show();
            $("#main").hide();
            $("#downloadErrorExcelA").hide();
            uuid=null;
        }
    }

</script>

</html>